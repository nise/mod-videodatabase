/*
 videodatabase 2021-10-15 
*/

define(["jquery",M.cfg.wwwroot+"/mod/videodatabase/amd/src/lib/vue.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/lib/vue-router.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/lib/vue-i18n.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/datamodel.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/components/Store.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/components/Form.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/components/Video.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/components/Comments.js",M.cfg.wwwroot+"/mod/videodatabase/amd/src/components/Utils.js"],function(c,i,r,l,e,u,d,f,m,p){console.log(M.cfg.wwwroot+"/mod/videodatabase/amd/src/lib/vue.js");var g=new e,h={id:parseInt(c("#courseid").html()),module:parseInt(c("#moduleid").html())};(new p).get_ws("videos",{courseid:h.id},function(e){var t=JSON.parse(e.data),n={username:e.username,firstname:e.firstname,lastname:e.lastname,id:e.userid,image:e.userimage};i.use(r),i.use(l);const o=new p,s=new u(t,h).store;var a=new f(s,h,n,c("#token").text()),e=a.video,t=new m(s,h,n,c("#token").text(),o).comments,n=new d(s,h,g,o);router=new r({routes:[{path:"/videos"},{path:"/videos/:id/view",component:e},{path:"/videos/:id/edit",component:n.Form},{path:"/videos/new",component:n.Form},{path:"/comments",component:t}],scrollBehavior:function(e,t,n){return{x:0,y:405}}}),t=new l({locale:"de",messages:{en:{message:{video_db_title:"Videos",teacher:"Teacher",pupil:"Pupils",ccby:"Creative Commons CC-BY",pd:"Public Domain",r:"Rights Reserved",football:"Fußball",handball:"Handball",barren:"Barren",judo:"Judo",volleyball:"Volleyball",athletics:"Leichtathletik",movement:"Bewegen und Handeln",reflexion:"Reflektieren und Urteilen",interaction:"Interagieren",methods:"Methoden anwenden",eingangsstufe:"Eingangsstufe",unterstufe:"Unterstufe",mittelstufe:"Mittelstufe",werkstufe:"Werkstufe",k1:"Klassenstufe 1",k2:"Klassenstufe 2",k3:"Klassenstufe 3",k4:"Klassenstufe 4",k5:"Klassenstufe 5",k6:"Klassenstufe 6",k7:"Klassenstufe 7",k8:"Klassenstufe 8",k9:"Klassenstufe 9",k10:"Klassenstufe 10",k11:"Klassenstufe 11",k12:"Klassenstufe 12",k13:"Klassenstufe 13",lsws:"Laufen, Springen, Werfen, Stoßen",games:"Spiele",ass:"Bewegung an Geräten",fight:"Kämpfen nach Regeln",moves:"Bewegungsfolgen gestalten und darstellen",water:"Bewegen im Wasser",cycling:"Fahren, Rollen, Gleiten",action1:"Abbauen",action2:"Aufbauen",action3:"Begründen",action4:"Beraten",action5:"Beschreiben",action6:"Besprechen",action7:"Beurteilen",action8:"Demonstrieren",action9:"Disziplinieren",action10:"Erklären",action11:"Feedback, Korrektur",action12:"Gesprächsrunde",action13:"Gruppenbildung",action14:"Helfen",action15:"Kooperieren",action16:"Medieneinsatz",action17:"Motivieren",action18:"Organisieren",action19:"Präsentieren",action20:"Sichern",action21:"Störung",action22:"Üben",persp1:"Leistung",persp2:"Wagnis",persp3:"Gestaltung",persp4:"Körpererfahrung",persp5:"Kooperation",persp6:"Gesundheit",hall:"Sporthalle",pool:"Schwimmhalle",outdoor:"Outdoor"}},de:{message:{video_db_title:"Videos",teacher:"Lehrer/in",pupil:"Schüler/in",ccby:"Creative Commons CC-BY",pd:"Public Domain",r:"Rights Reserved",football:"Fußball",handball:"Handball",barren:"Barren",judo:"Judo",volleyball:"Volleyball",athletics:"Leichtathletik",movement:"Bewegen und Handeln",reflexion:"Reflektieren und Urteilen",interaction:"Interagieren",methods:"Methoden anwenden",eingangsstufe:"Eingangsstufe",unterstufe:"Unterstufe",mittelstufe:"Mittelstufe",werkstufe:"Werkstufe",k1:"Klassenstufe 1",k2:"Klassenstufe 2",k3:"Klassenstufe 3",k4:"Klassenstufe 4",k5:"Klassenstufe 5",k6:"Klassenstufe 6",k7:"Klassenstufe 7",k8:"Klassenstufe 8",k9:"Klassenstufe 9",k10:"Klassenstufe 10",k11:"Klassenstufe 11",k12:"Klassenstufe 12",k13:"Klassenstufe 13",lsws:"Laufen, Springen, Werfen, Stoßen",games:"Spiele",ass:"Bewegung an Geräten",fight:"Kämpfen nach Regeln",moves:"Bewegungsfolgen gestalten und darstellen",water:"Bewegen im Wasser",cycling:"Fahren, Rollen, Gleiten",action1:"Abbauen",action2:"Aufbauen",action3:"Begründen",action4:"Beraten",action5:"Beschreiben",action6:"Besprechen",action7:"Beurteilen",action8:"Demonstrieren",action9:"Disziplinieren",action10:"Erklären",action11:"Feedback, Korrektur",action12:"Gesprächsrunde",action13:"Gruppenbildung",action14:"Helfen",action15:"Kooperieren",action16:"Medieneinsatz",action17:"Motivieren",action18:"Organisieren",action19:"Präsentieren",action20:"Sichern",action21:"Störung",action22:"Üben",persp1:"Leistung",persp2:"Wagnis",persp3:"Gestaltung",persp4:"Körpererfahrung",persp5:"Kooperation",persp6:"Gesundheit",hall:"Sporthalle",pool:"Schwimmhalle",outdoor:"Outdoor"}}}}),new i({el:"#app-videomanager",router:router,i18n:t,data:{mouseOverCheck:"",show:!1,isEditor:!0,listView:!1,search:"",videoRatings:{}},computed:{columnObject:function(){return"col-xs-12 col-sm-5 col-md-2 video-item "},videos:function(){return s.state.videos},filteredList:function(){return Object.values(s.getters.videos()).filter(e=>Object.values(e).join(" ").toLowerCase().includes(this.search.toLowerCase()))}},created:function(){var r=this;o.get_ws("ratings",{courseid:h.id},function(e){try{var t,n,o,s,a={},i=Object.values(JSON.parse(e.data));for(t in i)i.hasOwnProperty(t)&&(void 0===a[i[t].videoid]&&(a[i[t].videoid]=[]),a[i[t].videoid].push(i[t].rating));for(n in a)a.hasOwnProperty(n)&&0<a[n].length&&(o=a[n].filter(function(e){return 2<e}),s=5*r.wilsonScore(o.length,a[n].length),r.videoRatings[n]=Math.round(s))}catch(e){console.error(e)}})},methods:{wilsonScore:function(e,t){var n=Math.sqrt(2),e=+e/t;return(e+n/(2*t)-1.96*Math.sqrt((e*(1-e)+n/(4*t))/t))/(1+n/t)},imageLoadError:function(e){document.getElementById("video-img-"+e).src="images/stills/default.jpg"},setListView:function(){this.listView=!0},setTableView:function(){this.listView=!1},toogleForm:function(e){s.commit("toggleForm",e)},videoItemClass:function(e){var a=s.getters.videoById(e),e=function(e){for(var t="",n=[],o=0,s=(n=a[e]&&"string"==typeof a[e]?a[e].split(";"):n).length;o<s;o++)t+=" "+e+"-"+n[o].replace(/\ /g,"")+" ";return t};return[e("courselevel"),e("competencies"),e("activities"),e("perspectives"),a.actors?"actors-"+a.actors.replace(/\//g,""):"",a.location?"location-"+a.location:"",a.sports?"sports-"+a.sports.replace(/,\ /g,""):"",a.movements?"movements-"+a.movements.replace(/, /g,""):"",""].join(" ")},downloadLogData:function(){o.get_ws("get_log",{courseid:h.id},function(e){var t=Object.values(JSON.parse(e.response)).map(function(e){return JSON.parse(e.entry)});0===t.length?alert("Es liegen noch keine Logdaten vor."):(e=Object.keys(t[0]),(t=t.map(function(e){return Object.values(e)})).unshift(e),function(e,t){for(var n="",o=0;o<t.length;o++)n+=function(e){for(var t="",n=0;n<e.length;n++){var o=null===e[n]?"":e[n].toString(),o=(o=e[n]instanceof Date?e[n].toLocaleString():o).replace(/"/g,'""');0<n&&(t+=","),t+=o=0<=o.search(/("|,|\n)/g)?'"'+o+'"':o}return t+"\n"}(t[o]);var s=new Blob([n],{type:"text/csv;charset=utf-8;"});{var a;navigator.msSaveBlob?navigator.msSaveBlob(s,e):void 0!==(a=document.createElement("a")).download&&(s=URL.createObjectURL(s),a.setAttribute("href",s),a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a))}}("moodle-videodatabase-log-data-.csv",t))})}},components:{rating:a.rating}})}),c(function(){var o=[];c.each(g.data.groups[2].fields,function(e,t){if(t.filterable){o=['<select id="filter_'+t.model+'" class="sel2 '+(t.multi?"multi-filter":"single-filter")+'" '+(t.multi?' multiple="multiple" ':"")+">",'<option class="option-head" value="all" selected>'+t.label+" (alle)</option>"];for(var n=0;n<t.values.length;n++)o.push('<option value="'+t.model+"-"+t.values[n].replace(/\//g,"").replace(/,\ /g,"").replace(/\ /g,"")+'">'+t.values[n]+"</option>");o.push("</select>"),c("#filter1").append(o.join(""))}});var l={};function t(){c(".video-item").hide().filter(function(){var a=c(this),i={},r=a.attr("class").split(" ");void 0!==l&&Object.keys(l).forEach(function(s){l[s]&&Object.keys(l[s]).forEach(function(e){var t,n,o;"m_"===s.substr(0,2)&&l[s][e]&&"none"!=l[s][e]&&"all"!=l[s][e]?i[s]=(t=l[s],n=r,o=!1,Object.keys(t).forEach(function(e){-1!==n.indexOf(e)&&(o=!0)}),o):l[s][e]&&"none"!=l[s][e]&&"all"!=l[s][e]&&(i[s]=a.hasClass(l[s][e]))})});var e,t=!0;for(e in i)i.hasOwnProperty(e)&&(t=i[e]&&t);return t}).show()}c(document.body).on("change",".single-filter",function(){var e=c(this).attr("id").replace("filter_","");l["s_"+e]={},""===this.value?l["s_"+e][e]="null":l["s_"+e][e]=this.value,t()}),c(document.body).on("change",".multi-filter",function(){var n=c(this).attr("id").replace("filter_","");l["m_"+n]={},c(this).find("option").each(function(e,t){delete l["m_"+n][c(t).attr("value")]}),c("#filter_"+n+" :selected").each(function(e,t){l["m_"+n][c(t).attr("value")]=c(this).attr("value")}),t()})})});