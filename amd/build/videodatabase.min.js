/*
 videodatabase 2021-10-15 
*/

define(["jquery","amd/src/lib/vue.js","amd/src/lib/vue-router.js","amd/src/datamodel.js","amd/src/components/Store.js","amd/src/components/Form.js","amd/src/components/Video.js","amd/src/components/Comments.js","amd/src/components/Utils.js"],function(c,s,a,e,l,d,u,m,v){var f=new e,p={id:parseInt(c("#courseid").html()),module:parseInt(c("#moduleid").html())};const t=new v;t.get_ws("videos",{courseid:p.id},function(e){var t=JSON.parse(e.data),o={username:e.username,firstname:e.firstname,lastname:e.lastname,id:e.userid,image:e.userimage};s.use(a);const n=new v,i=new l(t,p).store;var r=new u(i,p,o,c("#token").text()),e=r.video,t=new m(i,p,o,c("#token").text(),n).comments,o=new d(i,p,f,n);router=new a({routes:[{path:"/videos"},{path:"/videos/:id/view",component:e},{path:"/videos/:id/edit",component:o.Form},{path:"/videos/new",component:o.Form},{path:"/comments",component:t}],scrollBehavior:function(e,t,o){return{x:0,y:405}}}),new s({el:"#app-videomanager",router:router,data:{mouseOverCheck:"",show:!1,isEditor:!0,listView:!1,search:"",videoRatings:{}},computed:{columnObject:function(){return"col-xs-12 col-sm-5 col-md-2 video-item "},videos:function(){return i.state.videos},filteredList:function(){return Object.values(i.getters.videos()).filter(e=>Object.values(e).join(" ").toLowerCase().includes(this.search.toLowerCase()))}},created:function(){var a=this;n.get_ws("ratings",{courseid:p.id},function(e){try{var t,o,n,i,r={},s=Object.values(JSON.parse(e.data));for(t in s)s.hasOwnProperty(t)&&(void 0===r[s[t].videoid]&&(r[s[t].videoid]=[]),r[s[t].videoid].push(s[t].rating));for(o in r)r.hasOwnProperty(o)&&0<r[o].length&&(n=r[o].filter(function(e){return 2<e}),i=5*a.wilsonScore(n.length,r[o].length),a.videoRatings[o]=Math.round(i))}catch(e){console.error(e)}})},methods:{wilsonScore:function(e,t){var o=Math.sqrt(2),e=+e/t;return(e+o/(2*t)-1.96*Math.sqrt((e*(1-e)+o/(4*t))/t))/(1+o/t)},imageLoadError:function(e){document.getElementById("video-img-"+e).src="images/stills/default.jpg"},setListView:function(){this.listView=!0},setTableView:function(){this.listView=!1},toogleForm:function(e){i.commit("toggleForm",e)},videoItemClass:function(e){var r=i.getters.videoById(e),e=function(e){for(var t="",o=[],n=0,i=(o=r[e]&&"string"==typeof r[e]?r[e].split(";"):o).length;n<i;n++)t+=" "+e+"-"+o[n].replace(/\ /g,"")+" ";return t};return[e("courselevel"),e("competencies"),e("activities"),e("perspectives"),r.actors?"actors-"+r.actors.replace(/\//g,""):"",r.location?"location-"+r.location:"",r.sports?"sports-"+r.sports.replace(/,\ /g,""):"",r.movements?"movements-"+r.movements.replace(/, /g,""):"",""].join(" ")},downloadLogData:function(){n.get_ws("get_log",{courseid:p.id},function(e){var t=Object.values(JSON.parse(e.response)).map(function(e){return JSON.parse(e.entry)});0===t.length?alert("Es liegen noch keine Logdaten vor."):(e=Object.keys(t[0]),(t=t.map(function(e){return Object.values(e)})).unshift(e),function(e,t){for(var o="",n=0;n<t.length;n++)o+=function(e){for(var t="",o=0;o<e.length;o++){var n=null===e[o]?"":e[o].toString(),n=(n=e[o]instanceof Date?e[o].toLocaleString():n).replace(/"/g,'""');0<o&&(t+=","),t+=n=0<=n.search(/("|,|\n)/g)?'"'+n+'"':n}return t+"\n"}(t[n]);var i=new Blob([o],{type:"text/csv;charset=utf-8;"});{var r;navigator.msSaveBlob?navigator.msSaveBlob(i,e):void 0!==(r=document.createElement("a")).download&&(i=URL.createObjectURL(i),r.setAttribute("href",i),r.setAttribute("download",e),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r))}}("moodle-videodatabase-log-data-.csv",t))})}},components:{rating:r.rating}})}),c(function(){var n=[];c.each(f.data.groups[2].fields,function(e,t){if(t.filterable){n=['<select id="filter_'+t.model+'" class="sel2 '+(t.multi?"multi-filter":"single-filter")+'" '+(t.multi?' multiple="multiple" ':"")+">",'<option class="option-head" value="all" selected>'+t.label+" (alle)</option>"];for(var o=0;o<t.values.length;o++)n.push('<option value="'+t.model+"-"+t.values[o].replace(/\//g,"").replace(/,\ /g,"").replace(/\ /g,"")+'">'+t.values[o]+"</option>");n.push("</select>"),c("#filter1").append(n.join(""))}});var l={};function t(){c(".video-item").hide().filter(function(){var r=c(this),s={},a=r.attr("class").split(" ");void 0!==l&&Object.keys(l).forEach(function(i){l[i]&&Object.keys(l[i]).forEach(function(e){var t,o,n;"m_"===i.substr(0,2)&&l[i][e]&&"none"!=l[i][e]&&"all"!=l[i][e]?s[i]=(t=l[i],o=a,n=!1,Object.keys(t).forEach(function(e){-1!==o.indexOf(e)&&(n=!0)}),n):l[i][e]&&"none"!=l[i][e]&&"all"!=l[i][e]&&(s[i]=r.hasClass(l[i][e]))})});var e,t=!0;for(e in s)s.hasOwnProperty(e)&&(t=s[e]&&t);return t}).show()}c(document.body).on("change",".single-filter",function(){var e=c(this).attr("id").replace("filter_","");l["s_"+e]={},""===this.value?l["s_"+e][e]="null":l["s_"+e][e]=this.value,t()}),c(document.body).on("change",".multi-filter",function(){var o=c(this).attr("id").replace("filter_","");l["m_"+o]={},c(this).find("option").each(function(e,t){delete l["m_"+o][c(t).attr("value")]}),c("#filter_"+o+" :selected").each(function(e,t){l["m_"+o][c(t).attr("value")]=c(this).attr("value")}),t()})})});